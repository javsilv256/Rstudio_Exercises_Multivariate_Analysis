{
  "hash": "fee35d44895282b7916d4f3b068719f3",
  "result": {
    "markdown": "---\ntitle: \"2023-02-14 Session 2\"\nformat: \n  html:\n    self-contained: true\neditor_options: \n  chunk_output_type: inline\n---\n\n\n-   Instituut Voor Tropische Geneeskunde - Antwerp, Belgium\n\n## Step by Step\n\n### Starting the Exercise\n\nThe data in ExerciseII.xls are results of an (hypothetical) observational cancer trial. The aim of the study was to compare two treatment strategies for a brain tumour: one of consists of local radiation (control regimen), one of a combination of local radiation and aggressive chemotherapy (test regimen). The endpoint of the study was survival duration after therapy.\n\nUse R to explore the data. Describe the patient demographics and survival using Kaplan-Meier curves. Do you think that the test regimen prolongs survival? Analyze the data further using Cox-regression. Describe your conclusions.\n\n::: callout-note\nImportant information: Analysis variable: Time to death Initial time: When the treatment begins End time: time of dead Independent variable: Type of treatment (local radiation vs local+chemotherapy)\n:::\n\n#### 1. First we import the data from an excel file\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(readxl)\nExerciseII <- read_excel(\"C:/Users/pined/OneDrive - Universidad Nacional Mayor de San Marcos/Javier 2022/Belgica/AC2/Survival Analysis Exercise Database/Exercises/ExerciseII.xls\")\n```\n:::\n\n\nTo start working with survival analysis we need an event variable (1 is the event happened, otherwise 0) In this case we have the \"died\" variable\n\n#### 2. Kaplan-Meyer curve (survival curve) for all the sample\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nlibrary(survival)\nmod0 <- survfit(Surv(time, died) ~ 1, data=ExerciseII)\n```\n````\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n#Kaplan-Meyer Graph\nplot(mod0, mark.time=TRUE)\n```\n\n::: {.cell-output-display}\n![](2023-02-14-Survival-Analysis-Session-2_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n![ ](SurvAnalysisSesion2Graph/fig1.jpg)\n\n#### 3. Kaplan-Meyer curve (survival curve) by group of treatment\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nmod1 <- survfit(Surv(time, died) ~ trt, data=ExerciseII)\nplot(mod1, mark.time=TRUE, lty=1:2)\nlegend (\"top\", legend=unique(ExerciseII$trt), lty=1:2)\n```\n````\n\n::: {.cell-output-display}\n![](2023-02-14-Survival-Analysis-Session-2_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n![ ](SurvAnalysisSesion2Graph/fig2.jpg)\n\nTo see the numbers\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmod1\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nCall: survfit(formula = Surv(time, died) ~ trt, data = ExerciseII)\n\n        n events median 0.95LCL 0.95UCL\ntrt=0 300    225    512     450     600\ntrt=1 200    151    434     332     605\n```\n:::\n:::\n\n\n::: callout-note\nTreatment 0 = Control = local radiation = 50% of the population was alive at day 512 Treatment 1 = Intervention = local + chemoteraphy = 50% of the population was alive at day 434\n\nSeems that in treatment 1, people tends to die more quickly\n:::\n\n#### 4. Creating Cox Regresion model (using the classical model)\n\n4.1 Creating Cox regresion with each of the (possible) predictors separately:\n\nPossible predictors: gender, trt an type (could be predictors/counfounders because this is not a clinical trial. In a clinical trial the amount of persons in each group is fixed)\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nlibrary(survival)\nCox1<- coxph(Surv(time, died) ~ trt, data=ExerciseII)\nCox2<- coxph(Surv(time, died) ~ gender, data=ExerciseII)\nCox3<- coxph(Surv(time, died) ~ type, data=ExerciseII)\n\nsummary(Cox1)\nsummary(Cox2)\nsummary(Cox3)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, died) ~ trt, data = ExerciseII)\n\n  n= 500, number of events= 376 \n\n      coef exp(coef) se(coef)     z Pr(>|z|)  \ntrt 0.2342    1.2638   0.1055 2.221   0.0264 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n    exp(coef) exp(-coef) lower .95 upper .95\ntrt     1.264     0.7912     1.028     1.554\n\nConcordance= 0.514  (se = 0.013 )\nLikelihood ratio test= 4.85  on 1 df,   p=0.03\nWald test            = 4.93  on 1 df,   p=0.03\nScore (logrank) test = 4.95  on 1 df,   p=0.03\n\nCall:\ncoxph(formula = Surv(time, died) ~ gender, data = ExerciseII)\n\n  n= 500, number of events= 376 \n\n           coef exp(coef) se(coef)     z Pr(>|z|)\ngenderM 0.03332   1.03388  0.10319 0.323    0.747\n\n        exp(coef) exp(-coef) lower .95 upper .95\ngenderM     1.034     0.9672    0.8446     1.266\n\nConcordance= 0.502  (se = 0.014 )\nLikelihood ratio test= 0.1  on 1 df,   p=0.7\nWald test            = 0.1  on 1 df,   p=0.7\nScore (logrank) test = 0.1  on 1 df,   p=0.7\n\nCall:\ncoxph(formula = Surv(time, died) ~ type, data = ExerciseII)\n\n  n= 500, number of events= 376 \n\n       coef exp(coef) se(coef)     z Pr(>|z|)    \ntype 1.2583    3.5193   0.1112 11.32   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n     exp(coef) exp(-coef) lower .95 upper .95\ntype     3.519     0.2841      2.83     4.376\n\nConcordance= 0.644  (se = 0.012 )\nLikelihood ratio test= 131.9  on 1 df,   p=<2e-16\nWald test            = 128.1  on 1 df,   p=<2e-16\nScore (logrank) test = 141.8  on 1 df,   p=<2e-16\n```\n:::\n:::\n\n\n::: callout-note\n| Factor |  HR   |    95% IC    | p-value |\n|:------:|:-----:|:------------:|:-------:|\n|  trt   | 1.264 | 1.028 1.554  | 0.0264  |\n| gender | 1.034 | 0.8446 1.266 |  0.747  |\n|  type  | 3.519 |  2.83 4.376  | \\<2e-16 |\n\nNow we select those with p \\<0.200 (or 0.100 depending on analysis plan) for further modeling\n:::\n\n4.2 Entering the remaining variables in a multivariable models and remove step-by-step the non-significant terms (always removing the least significant factor). \"Backwards elimination\"\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nlibrary(survival)\nCox4<- coxph(Surv(time, died) ~ trt + type , data=ExerciseII)\nsummary(Cox4)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, died) ~ trt + type, data = ExerciseII)\n\n  n= 500, number of events= 376 \n\n        coef exp(coef) se(coef)      z Pr(>|z|)    \ntrt  -0.5853    0.5569   0.1233 -4.747 2.06e-06 ***\ntype  1.5945    4.9257   0.1316 12.115  < 2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n     exp(coef) exp(-coef) lower .95 upper .95\ntrt     0.5569      1.796    0.4374    0.7092\ntype    4.9257      0.203    3.8058    6.3751\n\nConcordance= 0.67  (se = 0.013 )\nLikelihood ratio test= 154.6  on 2 df,   p=<2e-16\nWald test            = 149.9  on 2 df,   p=<2e-16\nScore (logrank) test = 163.7  on 2 df,   p=<2e-16\n```\n:::\n:::\n\n\n::: callout-note\nBoth are significant, so we need to keep both independent variables But, are they ok like that, or there is an interaction?\n:::\n\n4.3 Checking for interaction\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nCox5<- coxph(Surv(time, died) ~ trt * type , data=ExerciseII)\nsummary(Cox5)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, died) ~ trt * type, data = ExerciseII)\n\n  n= 500, number of events= 376 \n\n            coef exp(coef) se(coef)      z Pr(>|z|)    \ntrt      -0.1068    0.8987   0.2191 -0.487   0.6260    \ntype      1.7610    5.8185   0.1466 12.014   <2e-16 ***\ntrt:type -0.6405    0.5270   0.2584 -2.479   0.0132 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\ntrt         0.8987     1.1127    0.5850    1.3808\ntype        5.8185     0.1719    4.3656    7.7550\ntrt:type    0.5270     1.8974    0.3176    0.8745\n\nConcordance= 0.67  (se = 0.013 )\nLikelihood ratio test= 160.2  on 3 df,   p=<2e-16\nWald test            = 163.4  on 3 df,   p=<2e-16\nScore (logrank) test = 189.7  on 3 df,   p=<2e-16\n```\n:::\n:::\n\n\n::: callout-note\nThings to note: Seems that the interaction the treatment effect in the whole sample is no longer significant (HR: 0.8987, pvalue= 0.6260), but it is not true. Because of we are introducing interaction that HR= 0.8987 is the HR only for the local cancer.\n\n                         HR = 0.899^trt * 5.8185^type * 0.5270^(trt*type)\n                         \n    HR trt for local cancer = 0.899^trt               * 0.5270^(trt*0) \n    HR trt for local cancer = 0.899                   * 1 \n    HR trt for local cancer = 0.899\n\n    HR trt for metastatic cancer = 0.899 * 5.8185^1 * 0.5270^(trt*type)\n\n    HR trt for metastatic cancer = 0.899 * 0.527 = 0.473\n\nAlso looking only at interaction p-value (0.0132): seems significant\n:::\n\nWe need to compare both models\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(Cox5, Cox4, test=\"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nAnalysis of Deviance Table\n Cox model: response is  Surv(time, died)\n Model 1: ~ trt * type\n Model 2: ~ trt + type\n   loglik  Chisq Df P(>|Chi|)  \n1 -1995.9                      \n2 -1998.8 5.6712  1   0.01725 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n:::\n:::\n\n\n::: callout-note\nThere is a significant difference with and without interaction models So we keep with the interaction.\n:::\n\n4.4 Checking HR for each group of interaction\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntable(ExerciseII$type)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n\n  0   1 \n240 260 \n```\n:::\n\n```{.r .cell-code}\nLocalCancer  <-  subset(ExerciseII, type==0)  #Creating a database for local cancer\nMetastatic  <-  subset(ExerciseII, type==1)    #Creating a database for metastatic\n```\n:::\n\n\nChecking the kaplan meyer curve and cox regressiÃ³n in each subset\n\n4.4.1 IN LOCAL CANCER\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nmodLC <- survfit(Surv(time, died) ~ trt, data=LocalCancer)\nplot(modLC, mark.time=TRUE, lty=1:2)\nlegend (\"top\", legend=unique(LocalCancer$trt), lty=1:2)\n```\n````\n\n::: {.cell-output-display}\n![](2023-02-14-Survival-Analysis-Session-2_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n\n![ ](SurvAnalysisSesion2Graph/fig3_localcanc.jpg)\n\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\nCoxLC<- coxph(Surv(time, died) ~ trt, data=LocalCancer)\nsummary(CoxLC)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, died) ~ trt, data = LocalCancer)\n\n  n= 240, number of events= 151 \n\n       coef exp(coef) se(coef)      z Pr(>|z|)\ntrt -0.1020    0.9030   0.2191 -0.465    0.642\n\n    exp(coef) exp(-coef) lower .95 upper .95\ntrt     0.903      1.107    0.5877     1.387\n\nConcordance= 0.511  (se = 0.016 )\nLikelihood ratio test= 0.22  on 1 df,   p=0.6\nWald test            = 0.22  on 1 df,   p=0.6\nScore (logrank) test = 0.22  on 1 df,   p=0.6\n```\n:::\n:::\n\n\n4.4.2 IN METASTATIC CANCER\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\n#Kaplay-Meyer curve\nmodMC <- survfit(Surv(time, died) ~ trt, data=Metastatic)\nplot(modMC, mark.time=TRUE, lty=1:2)\nlegend (\"top\", legend=unique(Metastatic$trt), lty=1:2)\n```\n````\n\n::: {.cell-output-display}\n![](2023-02-14-Survival-Analysis-Session-2_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n![ ](SurvAnalysisSesion2Graph/fig4_metastasic.jpg)\n\n\n::: {.cell}\n\n````{.cell-code}\n```{{r}}\n#Cox regressiÃ³n\nCoxMC<- coxph(Surv(time, died) ~ trt, data=Metastatic)\nsummary(CoxMC)\n```\n````\n\n::: {.cell-output .cell-output-stdout}\n```\nCall:\ncoxph(formula = Surv(time, died) ~ trt, data = Metastatic)\n\n  n= 260, number of events= 225 \n\n       coef exp(coef) se(coef)      z Pr(>|z|)    \ntrt -0.7685    0.4637   0.1430 -5.375 7.67e-08 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n    exp(coef) exp(-coef) lower .95 upper .95\ntrt    0.4637      2.156    0.3504    0.6137\n\nConcordance= 0.592  (se = 0.018 )\nLikelihood ratio test= 28.13  on 1 df,   p=1e-07\nWald test            = 28.89  on 1 df,   p=8e-08\nScore (logrank) test = 30.19  on 1 df,   p=4e-08\n```\n:::\n:::\n\n\nAmong those with mett cancer,The ones that undergo the new treatment has 54% less hazard of die than the one that went with the traditional treatment.\n\nAmong those with mett cancer, getting the new treatment reduces your hazars of dying by 54%\n\nHR local cancer = 0.90 HR metastatic cancer = 0.46\n\nInteraction term = 0.46/0.90 = 0.51\n",
    "supporting": [
      "2023-02-14-Survival-Analysis-Session-2_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}